<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>foreach code execution</title>
    <link type="text/css" rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="settings">
      <label>
        Stop on
        <select id="stop_on">
          <option value="all">All</option>
          <option value="loop">Loop</option>
        </select>
      </label>
      <label>
        Step interval (ms)
        <input type="number" min="1" value="1000" id="step_interval" />
      </label>

      <label>
        Jump
        <input type="number" min="0" value="0" id="jump" />
      </label>
    </div>

    <div class="row">
      <div class="col">
        <div style="width: 500px; position: relative">
          <pre><code>
function saturation(pixels, adj) {
  let d = <span id="code_1">pixels.data</span>;
  adj = <span id="code_2">adj < -1 ? -1 : adj</span>;
  for (<span id="code_11">let i = 0</span>; <span id="code_12">i < d.length</span>; <span id="code_3">i += 4</span>) {
    const r = <span id="code_4">d[i];</span>
    const g = <span id="code_5">d[i + 1];</span>
    const b = <span id="code_6">d[i + 2];</span>
    // weights from CCIR 601 spec
    const gray = <span id="code_7">0.2989 * r + 0.587 * g + 0.114 * b;</span>
    d[i] = <span id="code_8">-gray * adj + d[i] * (1 + adj);</span>
    d[i + 1] = <span id="code_9">-gray * adj + d[i + 1] * (1 + adj);</span>
    d[i + 2] = <span id="code_10">-gray * adj + d[i + 2] * (1 + adj);</span>
  }
}
      </code></pre>
        </div>
      </div>
      <div class="col">
        <div id="progress"></div>
        <div class="state">
          <div class="row">
            <div class="col">
              <div class="pixel" id="original_pixel"></div>
            </div>
            <div class="col">
              <div class="pixel" id="transformed_pixel"></div>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <div class="pixel pixel-value" id="original_pixel_value"></div>
            </div>
            <div class="col">
              <div class="pixel pixel-value" id="transformed_pixel_value"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <canvas id="original_image"></canvas>
      </div>
      <div class="col">
        <canvas id="transformed_image"></canvas>
      </div>
    </div>
    <script src="./js/filters.js"></script>
    <script src="./js/utils.js"></script>

    <script>
      const original_canvas = document.getElementById("original_image");
      const original_ctx = original_canvas.getContext("2d");
      const transformed_canvas = document.getElementById("transformed_image");
      const transformed_ctx = transformed_canvas.getContext("2d");
      const img = new Image();
      let pixels;
      let o_pixels;

      function render() {
        const current = getCurrent();
        transformed_ctx.putImageData(pixels, 0, 0);

        if (current == null) return;
        if (current.ctx.i != null) {
          document.getElementById("progress").innerText = `${
            current.ctx.i / 4 + 1
          }/${o_pixels.data.length / 4} (${(
            ((current.ctx.i + 1) / o_pixels.data.length) *
            100
          ).toFixed(1)}%)`;
          const o_r = o_pixels.data[current.ctx.i];
          const o_g = o_pixels.data[current.ctx.i + 1];
          const o_b = o_pixels.data[current.ctx.i + 2];
          document.getElementById(
            "original_pixel"
          ).style.backgroundColor = `rgb(${o_r}, ${o_g}, ${o_b})`;
          document.getElementById(
            "original_pixel_value"
          ).innerHTML = `<div class="r">${o_r}</div><div class="g">${o_g}</div><div class="b">${o_b}</div>`;

          const r = pixels.data[current.ctx.i];
          const g = pixels.data[current.ctx.i + 1];
          const b = pixels.data[current.ctx.i + 2];
          document.getElementById(
            "transformed_pixel"
          ).style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
          document.getElementById(
            "transformed_pixel_value"
          ).innerHTML = `<div class="r">${r}</div><div class="g">${g}</div><div class="b">${b}</div>`;
        } else {
          document.getElementById("progress").innerText = `0/${
            o_pixels.data.length / 4
          } (0%)`;
        }
      }

      function runStep() {
        // update options
        stopOn(document.getElementById("stop_on").value);
        jump(document.getElementById("jump").value);
        const int = document.getElementById("step_interval").value;

        // execute code
        step(true); // advance execution and display evolution

        // render
        render();

        // execute next step
        if (int == 0) {
          runStep();
        } else {
          setTimeout(runStep, int);
        }
      }

      async function init() {
        console.log("Start execution");
        o_pixels = original_ctx.getImageData(0, 0, img.width, img.height);

        transformed_ctx.clearRect(0, 0, img.width, img.height);
        pixels = transformed_ctx.getImageData(0, 0, img.width, img.height);

        saturation(o_pixels, pixels, -1);
        runStep();
      }

      (async () => {
        img.onload = async () => {
          original_canvas.width = img.width;
          original_canvas.height = img.height;

          transformed_canvas.width = img.width;
          transformed_canvas.height = img.height;

          original_ctx.drawImage(img, 0, 0);

          await init();
        };
        img.src = "../ui_demo/img/portrait.jpg";
      })();
    </script>
  </body>
</html>
